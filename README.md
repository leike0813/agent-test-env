# agent-test-env

Managed-prefix isolated runtime for installing, starting, and upgrading one Agent CLI tool per command invocation.

## Quick Start

1. Review base config in `agent-env.config.json` and bundled agent presets in `agents/*.json`.
2. Bootstrap project-local managed prefix:

```bash
npm run bootstrap
```

3. Install one agent into the managed prefix:

```bash
npm run install -- codex
```

4. Start one agent (supports passthrough args):

```bash
npm run start -- codex -- --model gpt-5
```

The command prints `Run id` and `Run directory` for replay and inspection.

5. Upgrade one agent:

```bash
npm run upgrade -- codex
```

## Commands

- `npm run bootstrap`
  - Creates/refreshes managed prefix directories.
  - Verifies executables for agents where `requiredOnBootstrap` is `true`.
- `npm run install -- <agent>`
  - Runs fixed install command for exactly one configured agent.
- `npm run start -- <agent> [args...]`
  - Starts exactly one configured agent with managed-prefix executable resolution.
  - Forwards all trailing args to the agent process unchanged.
  - Supports existing run reuse via `--run-dir <selector>` before `<agent>`.
- `npm run upgrade -- <agent>`
  - Runs fixed upgrade command for exactly one configured agent.
- Backward compatible aliases remain available:
  - `npm run install-agent -- <agent>`
  - `npm run start-agent -- <agent> [args...]`
  - `npm run upgrade-agent -- <agent>`
- `npm run test`
  - Runs automated checks for bootstrap, launch orchestration, and config isolation.
- `npm run typecheck`
  - Runs syntax/type guard checks over source, test, bin, and scripts directories.

## Directory Layout

Managed prefix root defaults to `.managed-prefix/` and contains:

- `bin/`: managed executable resolution root
- `state/`: project-local runtime state
- `logs/`: runtime logs
- `metadata/`: launcher metadata
- `home/`: isolated HOME roots for launched processes
- `runs/`: per-run isolated execution directories and audit artifacts

Default agent config locations (inside isolated `HOME`):
- codex: `.managed-prefix/home/default/.codex`
- gemini: `.managed-prefix/home/default/.gemini`
- iflow: `.managed-prefix/home/default/.iflow`
- opencode: `.managed-prefix/home/default/.opencode`
- xdg config: `.managed-prefix/home/default/.config`

Bundled agent preset files:
- `agents/codex.json`
- `agents/gemini.json`
- `agents/iflow.json`
- `agents/opencode.json`

## Isolation and Diagnostics

- Runtime prepends managed `bin` to `PATH`.
- Runtime exports isolated `XDG_*` roots under `HOME` (`.config`, `.local/state`, `.local/share`).
- Runtime detects host-global path leakage and aborts before spawn when detected.
- Runtime prints diagnostics for effective command and key config roots per agent.
- `start` runs in PTY mode (Linux only) so Agent CLI tools get real terminal semantics.
- PTY runtime depends on `script` and `strace`; startup fails fast when either command is unavailable.

## Run Audit Artifacts

Each `start` invocation creates a dedicated run directory:

- `.managed-prefix/runs/<run-id>/`

The run directory includes audit artifacts under `.audit/`:

- `.audit/meta.json`: launch command, timestamps, exit status/signal, trust registration info
- `.audit/stdin.log`: captured stdin stream
- `.audit/stdout.log`: captured stdout stream
- `.audit/stderr.log`: captured stderr stream
- `.audit/pty-output.log`: raw merged PTY output
- `.audit/pty-timing.log`: PTY timing file generated by `script`
- `.audit/fd-trace.log`: tracer output used for stdout/stderr reconstruction
- `.audit/fs-before.json`: pre-run snapshot
- `.audit/fs-after.json`: post-run snapshot
- `.audit/fs-diff.json`: created/modified/deleted files

Run reuse selector modes (`--run-dir <selector>`):

- Path mode: absolute or relative run directory path.
- Full run id mode: `<timestamp>-<agent>-<suffix8>`.
- Short run id mode: trailing 8-char hex suffix only.
- Short-id ambiguity is rejected: if multiple runs match the same suffix, command fails and requires full run id or path.

Run discovery index:

- `.managed-prefix/runs/index.json`

Filesystem diff notes:

- Diff output excludes recorder-generated fixed audit files under `.audit/`.
- Diff is based on pre/post snapshots; transient files created and deleted during a run may not appear.

Replay notes:

- `stdout.log` and `stderr.log` are reconstructed from fd-write traces during PTY execution.
- For advanced TTY behaviors, reconstructed stream boundaries may differ from what users visually observe in a live terminal.
- When reusing an existing run directory, `stdin.log`, `stdout.log`, and `stderr.log` are append-only across attempts.

Trust registration before start:

- `codex`: appends TOML table block below to `$HOME/.codex/config.toml`
  - `[projects."<run_abs_path>"]`
  - `trust_level = "trusted"`
- `gemini`: writes `"<run_abs_path>": "TRUST_FOLDER"` to `$HOME/.gemini/trustedFolders.json`

Cleanup:

- Run directories are persistent by design for replay.
- Users can remove old run directories manually from `.managed-prefix/runs/`.
- Legacy config paths are not auto-migrated; move old files manually if needed.
